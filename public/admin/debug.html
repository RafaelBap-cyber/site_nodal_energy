<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debug CMS - Nodal Energy</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .debug-info {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .error {
      color: #e74c3c;
      background: #fdf2f2;
      border: 1px solid #fecaca;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success {
      color: #059669;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    button {
      background: #4ade80;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #22c55e;
    }
  </style>
</head>
<body>
  <h1>Debug do CMS - Nodal Energy</h1>
  
  <div class="debug-info">
    <h3>Status do Sistema</h3>
    <div id="status">Verificando...</div>
  </div>

  <div class="debug-info">
    <h3>Testes</h3>
    <button onclick="testCMS()">Testar CMS</button>
    <button onclick="testBackend()">Testar Backend</button>
    <button onclick="testConfig()">Testar Configuração</button>
    <button onclick="openBlogEditor()">Abrir Editor de Blog</button>
  </div>

  <div class="debug-info">
    <h3>Logs</h3>
    <div id="logs" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; max-height: 300px; overflow-y: auto;"></div>
  </div>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
  
  <script>
    let logCount = 0;
    
    function log(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.style.color = type === 'error' ? '#e74c3c' : type === 'success' ? '#059669' : '#333';
      logEntry.textContent = `[${timestamp}] ${message}`;
      logsDiv.appendChild(logEntry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
      logCount++;
    }

    function updateStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="${type === 'error' ? 'error' : type === 'success' ? 'success' : ''}">${message}</div>`;
    }

    function testCMS() {
      log('Testando carregamento do CMS...');
      
      if (typeof CMS !== 'undefined') {
        log('✅ CMS carregado com sucesso!', 'success');
        updateStatus('CMS carregado com sucesso!', 'success');
        
        // Verificar se o CMS está funcionando
        try {
          CMS.registerPreviewTemplate('blog', ({ entry }) => {
            log('✅ Template de preview registrado com sucesso', 'success');
            return '<div>Preview funcionando!</div>';
          });
        } catch (error) {
          log(`❌ Erro ao registrar template: ${error.message}`, 'error');
        }
      } else {
        log('❌ CMS não foi carregado', 'error');
        updateStatus('CMS não foi carregado', 'error');
      }
    }

    function testBackend() {
      log('Testando backend...');
      
      if (typeof CMS !== 'undefined') {
        try {
          // Tentar acessar a configuração do backend
          const backend = CMS.getBackend();
          log(`✅ Backend disponível: ${backend.name || 'Não especificado'}`, 'success');
        } catch (error) {
          log(`❌ Erro no backend: ${error.message}`, 'error');
        }
      } else {
        log('❌ CMS não disponível para teste de backend', 'error');
      }
    }

    function testConfig() {
      log('Testando configuração...');
      
      // Verificar se o arquivo config.yml está acessível
      fetch('/admin/config.yml')
        .then(response => {
          if (response.ok) {
            log('✅ Arquivo config.yml acessível', 'success');
            return response.text();
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        })
        .then(content => {
          log(`✅ Configuração carregada (${content.length} caracteres)`, 'success');
          // Verificar se contém as coleções necessárias
          if (content.includes('collections:')) {
            log('✅ Estrutura de coleções encontrada', 'success');
          } else {
            log('⚠️ Estrutura de coleções não encontrada', 'error');
          }
        })
        .catch(error => {
          log(`❌ Erro ao carregar config.yml: ${error.message}`, 'error');
        });
    }

    function openBlogEditor() {
      log('Tentando abrir editor de blog...');
      
      try {
        // Tentar abrir o editor diretamente
        const url = '/admin/#/collections/blog';
        log(`Abrindo: ${url}`);
        
        // Verificar se o CMS está carregado
        if (typeof CMS !== 'undefined') {
          log('✅ CMS disponível, redirecionando...', 'success');
          window.location.href = url;
        } else {
          log('❌ CMS não disponível, tentando abrir em nova aba...', 'error');
          window.open(url, '_blank');
        }
      } catch (error) {
        log(`❌ Erro ao abrir editor: ${error.message}`, 'error');
      }
    }

    // Verificação automática ao carregar
    window.addEventListener('load', () => {
      log('Página carregada, iniciando verificações...');
      
      setTimeout(() => {
        testCMS();
        testConfig();
      }, 1000);
    });

    // Verificar erros globais
    window.addEventListener('error', (event) => {
      log(`❌ Erro global: ${event.message}`, 'error');
    });

    // Verificar se o Netlify Identity está funcionando
    if (typeof netlifyIdentity !== 'undefined') {
      log('✅ Netlify Identity carregado', 'success');
    } else {
      log('⚠️ Netlify Identity não carregado', 'error');
    }
  </script>
</body>
</html>
